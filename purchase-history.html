<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase History - Urban Walker Vault</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="Urban_Walker_Favicon.ico?v=2">
</head>
<body>
    
    <header>
        <hi>Purchase History</hi>
        <nav>
            <ul>
                <li><a href="#" onClick="signOut()">Sign Out</a></li>
            </ul>
        </nav>
    </header>

    <main class="dashboard-page">
        <h2>All Completed Purchases</h2>
        <table id="purchaseTable">
            <thead>
                <tr>
                    <th>Date & Time</th>
                    <th>User</th>
                    <th>Items</th>
                    <th>Description</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- Purchase records will be dynamically inserted here -->
            </tbody>
        </table>
    </main>

    <footer>
        <p>Â© 2025 Urban Walker Vault. All rights reserved.</p>
    </footer>

    <script>
const API_BASE = "https://urban-walker-vault.onrender.com/api";

/* Load purchase history */
async function loadPurchaseHistory() {
    const tbody = document.querySelector("#purchaseTable tbody");
    tbody.innerHTML = `<tr><td colspan="5">Loading...</td></tr>`;

    try {
        const res = await fetch(`${API_BASE}/purchases`);
        const data = await res.json();

        tbody.innerHTML = "";

        if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5">No purchase records found.</td></tr>`;
            return;
        }

        data.forEach(p => {
            const formattedItems = Array.isArray(p.items)
                ? p.items.map(i => `${i.name} (x${i.quantity})`).join("<br>")
                : p.items;

            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td>${new Date(p.timestamp).toLocaleString()}</td>
                <td>${p.user || "Unknown"}</td>
                <td>${formattedItems}</td>
                <td>${p.description || "-"}</td>
                <td>R ${p.total?.toFixed(2) || "0.00"}</td>
            `;

            tbody.appendChild(tr);
        });

    } catch (err) {
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="5">Failed to load purchase history.</td></tr>`;
    }
}

/* Sign Out */
function signOut() {
    localStorage.removeItem("jwtToken");
    window.location.href = "signin.html";
}

document.addEventListener("DOMContentLoaded", loadPurchaseHistory);
</script>

</body>
</html>